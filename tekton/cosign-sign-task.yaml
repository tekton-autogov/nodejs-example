apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: cosign-sign
spec:
  params:
  - name: image
    description: The image to sign.
    type: string
  - name: cosign-image
    description: The image with cosign in it that you want to run this Task in.
    default: image-registry.openshift-image-registry.svc:5000/openshift/cosign
    type: string

  workspaces:
  - name: key
    description: Mount a secret in the format generated by the cosign generate-key-pair command. It should have an entry named "cosign.key" with the private key that will be used to sign the image, and 2) an entry named "cosign.password" with the key's password.

  steps:
  - name: sign
    image: $(params.cosign-image)
    command: ["/bin/bash", "-c"]
    env:
    - name: IMAGE
      value: $(params.image)
    - name: KEY_WORKSPACE
      value: $(workspaces.key.path)
    args:
    - |-
      export COSIGN_PASSWORD=`cat ${KEY_WORKSPACE}/cosign.password`
      cosign sign --key ${KEY_WORKSPACE}/cosign.key $(params.image)

