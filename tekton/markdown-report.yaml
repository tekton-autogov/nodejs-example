apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: markdown-report
spec:
  params:
    - name: git-clone-params-url
      type: string
    - name: git-clone-params-subdirectory
      type: string
    - name: git-clone-params-revision
      type: string
    - name: git-clone-results-commit
      type: string
    - name: git-clone-results-url
      type: string

    - name: build-image-params-IMAGE
      type: string
    - name: build-image-params-TLSVERIFY
      type: string
    - name: build-image-results-IMAGE_DIGEST
      type: string

    - name: deploy-dev-params-charts_dir
      type: string
    - name: deploy-dev-params-overwrite_values
      type: string

  steps:
    - name: report
      image: image-registry.openshift-image-registry.svc:5000/openshift/cli:latest
      command: ["/bin/bash", "-c"]
      env:
      - name: git-clone-params-url
        value: $(params.git-clone-params-url)
      - name: git-clone-params-subdirectory
        value: $(params.git-clone-params-subdirectory)
      - name: git-clone-params-revision
        value: $(params.git-clone-params-revision)
      - name: git-clone-results-commit
        value: $(params.git-clone-results-commit)
      - name: git-clone-results-url
        value: $(params.git-clone-results-url)
  
      - name: build-image-params-IMAGE
        value: $(params.build-image-params-IMAGE)
      - name: build-image-params-TLSVERIFY
        value: $(params.build-image-params-TLSVERIFY)
      - name: build-image-results-IMAGE_DIGEST
        value: $(params.build-image-results-IMAGE_DIGEST)
  
      - name: deploy-dev-params-charts_dir
        value: $(params.deploy-dev-params-charts_dir)
      - name: deploy-dev-params-overwrite_values
        value: $(params.deploy-dev-params-overwrite_values)

      args:
        - |-
          DEPLOY_DEV_FACTS_ROUTE_NAME=`oc get route -o name | sort | head -n 1`
          DEPLOY_DEV_FACTS_ROUTE_URL=https://`oc get ${ROUTE_NAME} -o jsonpath='{.spec.host}'`/

          cat << EOF | tee report.md
          # Pipeline Report
          
          ## Task - Git Clone
          ### Params
          | Name                      | Value      |
          | -------- | --------------------------- |
          | url      | ${git-clone-params-url}     |
          | revision | ${git-clone-params-revision}|
          ### Results
          | Name     | Value                       |
          | url      | ${git-clone-results-url}    |
          | commit   | ${git-clone-results-commit} |
 
          ## Task - Build Image
          ### Params
          | Name                         | Value       |
          | --------- | ----------- |
          | IMAGE     | ${build-image-params-IMAGE} |
          | TLSVERIFY | ${build-image-params-TLSVERIFY} |
          ### Results
          | Name                             | Value                                      |
          | -------------------------------- | ------------------------------------------ |
          | IMAGE_DIGEST | ${build-image-results-IMAGE_DIGEST} |

          ## Task - Deploy: DEV
          ### Params
          | Name                               | Value                                        |
          |------------------------------------| -------------------------------------------- |
          | charts_dir       | ${deploy-dev-params-charts_dir}       |
          | overwrite_values | ${deploy-dev-params-overwrite_values} |

          ### Results
          | Name       | Value                                        |
          |------------| ------------------------------ |
          | Route Name | ${DEPLOY_DEV_FACTS_ROUTE_NAME} |
          | Route URL  | ${DEPLOY_DEV_FACTS_ROUTE_URL}  |
          EOF

